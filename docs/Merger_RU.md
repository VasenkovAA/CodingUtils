
# Полное руководство по использованию утилиты `merger.py`

## Содержание
1. [Введение](#введение)
2. [Основные возможности](#основные-возможности)
3. [Установка и запуск](#установка-и-запуск)
4. [Базовое использование](#базовое-использование)
5. [Параметры поиска файлов](#параметры-поиска-файлов)
6. [Фильтрация и исключения](#фильтрация-и-исключения)
7. [Использование .gitignore](#использование-gitignore)
8. [Расширенные сценарии](#расширенные-сценарии)
9. [Формат выходного файла](#формат-выходного-файла)
10. [Примеры использования](#примеры-использования)
11. [Обработка ошибок](#обработка-ошибок)
12. [Советы и рекомендации](#советы-и-рекомендации)

---

## Введение

`merger.py` - это мощная утилита командной строки для объединения содержимого нескольких файлов в один файл с сохранением структуры и заголовков. Она предназначена для:
- Создания архива кодовой базы
- Генерации документации из исходного кода
- Анализа структуры проекта
- Экспорта конфигурационных файлов
- Создания бэкапов с сохранением контекста

## Основные возможности

✅ **Поиск файлов:**
- Рекурсивный поиск по директориям
- Поддержка шаблонов (wildcards)
- Множественные директории поиска
- Прямое указание файлов

✅ **Фильтрация:**
- Исключение по имени директории
- Исключение по шаблону имени файла
- Исключение по полному пути
- Поддержка .gitignore файлов

✅ **Выходные данные:**
- Структурированные заголовки файлов
- Информация о процессе слияния
- Статистика файлов
- Поддержка разных кодировок

✅ **Дополнительные функции:**
- Предварительный просмотр (preview mode)
- Гибкая настройка исключений
- Обработка ошибок чтения
- Логирование процесса

## Установка и запуск

### Требования
- Python 3.6+
- Стандартные библиотеки Python (нет внешних зависимостей)

### Запуск
```bash
# Базовая форма
file-merger [опции] [файлы...]

# Проверка установки
file-merger --help
```

## Базовое использование

### Простейший пример
```bash
# Объединить все файлы в текущей директории
file-merger -o merged.txt

# Объединить все .py файлы
file-merger -p "*.py" -o python_files.txt

# Объединить файлы из нескольких директорий
file-merger -d src -d utils -r -o project_files.txt
```

### Режим предварительного просмотра
```bash
# Посмотреть, что будет объединено
file-merger -r --preview

# Предварительный просмотр с фильтрами
file-merger -d src -r --preview -p "*.py"
```

## Параметры поиска файлов

### Основные параметры

| Параметр | Короткая форма | Описание | По умолчанию |
|----------|----------------|----------|--------------|
| `--files` | (позиционные) | Явный список файлов | - |
| `--directory` | `-d` | Директория для поиска | текущая |
| `--recursive` | `-r` | Рекурсивный поиск | False |
| `--pattern` | `-p` | Шаблон поиска файлов | `*` |
| `--output` | `-o` | Выходной файл | `merged_files.txt` |

### Примеры поиска

```bash
# Поиск в одной директории
file-merger -d /path/to/project

# Рекурсивный поиск
file-merger -d src -r

# Поиск по шаблону
file-merger -p "*.txt"
file-merger -p "test_*.py"
file-merger -p "config.*"

# Несколько директорий
file-merger -d src -d tests -d docs -r

# Прямое указание файлов
file-merger file1.txt file2.py file3.json
```

## Фильтрация и исключения

### Флаги исключения

| Флаг | Короткая форма | Описание | Примеры |
|------|----------------|----------|---------|
| `--exclude-dir` | `-ed` | Исключить директории по имени | `-ed venv -ed __pycache__` |
| `--exclude-name` | `-en` | Исключить файлы по имени/шаблону | `-en "*.tmp" -en "temp_*"` |
| `--exclude-pattern` | `-ep` | Исключить по полному пути/шаблону | `-ep "*test*" -ep "*backup*"` |

### Примеры фильтрации

```bash
# Исключить системные директории
file-merger -r -ed venv -ed .git -ed __pycache__

# Исключить временные файлы
file-merger -r -en "*.tmp" -en "*.bak" -en "*.swp"

# Исключить тестовые файлы
file-merger -r -ep "*test*" -ep "*spec.*"

# Комбинированная фильтрация
file-merger -d src -r \
  -ed node_modules \
  -en "*.log" \
  -ep "*_old*" \
  -ep "*debug*"
```

### Приоритет фильтрации
1. Файлы, явно указанные в аргументах, проверяются первыми
2. `.gitignore` фильтры (если включены)
3. `--exclude-dir` (исключение директорий)
4. `--exclude-name` (исключение по имени файла)
5. `--exclude-pattern` (исключение по полному пути)

## Использование .gitignore

### Флаги .gitignore

| Флаг | Короткая форма | Описание |
|------|----------------|----------|
| `--gitignore` | `-gi` | Использовать указанный .gitignore файл |
| `--use-gitignore` | `-ig` | Автоматически найти .gitignore |

### Поддерживаемые синтаксисы .gitignore

```
# Комментарии
# Игнорировать все .pyc файлы
*.pyc

# Игнорировать директорию
__pycache__/

# Игнорировать в любом месте
**/temp/

# Игнорировать конкретный файл
secrets.env

# Исключение (префикс !)
!important.py
```

### Примеры использования .gitignore

```bash
# Использовать стандартный .gitignore
file-merger-r -ig

# Указать конкретный файл .gitignore
file-merger -r -gi /path/to/.gitignore

# Комбинировать с другими фильтрами
file-merger -r -ig -ed build -en "*.log"

# Использовать родительский .gitignore
file-merger -d src -r -gi ../.gitignore
```

## Расширенные сценарии

### Создание архива проекта
```bash
# Создать полный архив кода (без временных файлов)
file-merger -r -ig \
  -ed venv \
  -ed node_modules \
  -ed dist \
  -ed build \
  -en "*.pyc" \
  -en "*.class" \
  -o project_archive.txt
```

### Генерация документации
```bash
# Объединить только документы и конфиги
file-merger -d docs -d config -r \
  -p "*.md" \
  -p "*.txt" \
  -p "*.yaml" \
  -p "*.yml" \
  -p "*.json" \
  -o documentation.txt
```

### Слияние конфигурационных файлов
```bash
file-merger \
  config/database.yaml \
  config/appsettings.json \
  config/nginx.conf \
  -o all_configs.txt
```

### Анализ зависимостей
```bash
# Анализ файлов зависимостей
file-merger -r \
  -p "requirements*.txt" \
  -p "package.json" \
  -p "*.toml" \
  -p "*.lock" \
  -o dependencies.txt
```

## Формат выходного файла

### Структура выходного файла
```
MERGED FILES: X files
MERGE DATE: [дата]
ROOT DIRECTORY: [корневая директория]
EXCLUSIONS APPLIED: [если есть исключения]
============================================================

============================================================
FILE: относительный/путь/к/файлу.ext
============================================================
[содержимое файла]

============================================================
FILE: другой/файл.py
============================================================
[содержимое файла]

... и так далее для каждого файла
```

### Пример выходного файла
```
MERGED FILES: 3 files
MERGE DATE: Mon Dec 21 10:30:15 UTC 2024
ROOT DIRECTORY: /home/user/project
EXCLUSIONS APPLIED:
  Directories: tests, __pycache__
  Gitignore: auto-discovered .gitignore
============================================================

============================================================
FILE: src/main.py
============================================================
#!/usr/bin/env python3
def main():
    print("Hello World")

if __name__ == "__main__":
    main()

============================================================
FILE: src/utils.py
============================================================
import os

def read_file(path):
    with open(path) as f:
        return f.read()
```

## Примеры использования

### Пример 1: Создание снепшота проекта
```bash
file-merger -d . -r -ig \
  -ed ".git" \
  -ed "venv" \
  -ed "__pycache__" \
  -en "*.pyc" \
  -en "*.class" \
  -en "*.so" \
  -o "project_snapshot_$(date +%Y%m%d).txt"
```

### Пример 2: Слияние логов
```bash
# Объединить логи за последние 7 дней
file-merger -d /var/log/app \
  -p "app_*.log" \
  -r \
  -o "weekly_logs_$(date +%Y%m%d).txt"
```

### Пример 3: Экспорт настроек
```bash
file-merger \
  ~/.config/app/settings.conf \
  ~/.config/app/keybindings.conf \
  ~/.config/app/themes/theme.conf \
  -o "app_settings_export.txt"
```

### Пример 4: Анализ кода
```bash
# Анализ только исходного кода
file-merger -d src -r \
  -p "*.py" \
  -p "*.js" \
  -p "*.ts" \
  -ed "__pycache__" \
  -ed "node_modules" \
  -o "source_code_analysis.txt"
```

### Пример 5: Резервное копирование конфигов
```bash
# Резервная копия важных конфигов
file-merger -d /etc -r \
  -p "*.conf" \
  -p "*.cfg" \
  -ed "*.d" \
  -o "etc_backup_$(date +%Y%m%d_%H%M%S).txt"
```

## Обработка ошибок

### Типичные ошибки и решения

1. **"No files found to merge"**
   ```bash
   # Проверьте текущую директорию
   pwd
   
   # Проверьте существование файлов
   ls -la
   
   # Используйте рекурсивный поиск
   file-merger -r
   ```

2. **"Directory not found"**
   ```bash
   # Используйте абсолютный путь
   file-merger -d /absolute/path/to/dir
   
   # Или проверьте относительный путь
   file-merger -d ./relative/path
   ```

3. **Проблемы с кодировкой**
   - Скрипт автоматически пытается latin-1 если utf-8 не работает
   - Для нестандартных кодировок может потребоваться конвертация

4. **Файлы исключаются неправильно**
   ```bash
   # Используйте preview для отладки
   file-merger --preview -ed suspicious_dir
   
   # Проверьте чувствительность к регистру
   file-merger -en "*[Tt]emp*"
   ```

### Отладка фильтрации
```bash
# Шаг 1: Проверьте, какие файлы находятся в директории
find . -type f | head -20

# Шаг 2: Проверьте preview без фильтров
file-merger --preview

# Шаг 3: Добавляйте фильтры по одному
file-merger --preview -ed first_filter
file-merger --preview -ed first_filter -en second_filter
```

## Советы и рекомендации

### Производительность
1. **Для больших проектов** используйте более специфичные паттерны:
   ```bash
   # Вместо
   file-merger -r
   
   # Используйте
   file-merger -r -p "*.py" -p "*.js" -p "*.html"
   ```

2. **Исключайте тяжелые директории**:
   ```bash
   file-merger -r -ed node_modules -ed venv -ed .git
   ```

3. **Используйте .gitignore** для стандартных исключений.

### Безопасность
1. **Проверяйте содержимое** перед объединением конфиденциальных файлов
2. **Не включайте** файлы с паролями и секретами
3. **Используйте фильтры** для исключения чувствительных данных:
   ```bash
   file-merger -r -en "*.env" -en "*secret*" -en "*password*"
   ```

### Интеграция
1. **Скрипты оболочки**:
   ```bash
   #!/bin/bash
   TIMESTAMP=$(date +%Y%m%d_%H%M%S)
   file-merger -r -ig -o "backup_${TIMESTAMP}.txt"
   ```

2. **Makefile**:
   ```makefile
   .PHONY: snapshot
   snapshot:
       file-merger -r -ig -o "snapshot_$(shell date +%Y%m%d).txt"
   ```

3. **Планировщик задач** (cron):
   ```cron
   # Ежедневный снепшот в 2:00
   0 2 * * * cd /path/to/project && file-merger -r -ig -o "/backups/snapshot_$(date +\%Y\%m\%d).txt"
   ```

### Дополнительные возможности
1. **Сортировка файлов**: Файлы сортируются по алфавиту автоматически
2. **Статистика**: В preview показывается общий размер файлов
3. **Относительные пути**: В заголовках используются относительные пути от корня проекта
4. **Обработка ошибок**: Проблемные файлы отмечаются в выводе, но процесс продолжается

### Лучшие практики
1. **Всегда используйте `--preview`** перед первым запуском с новыми фильтрами
2. **Сохраняйте команды** в виде скриптов для повторного использования
3. **Именуйте выходные файлы** с датой для отслеживания версий
4. **Комбинируйте фильтры** для точного контроля над включаемыми файлами
5. **Используйте `.gitignore`** для согласованных исключений в команде

